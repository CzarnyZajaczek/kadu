dnl $Id: configure.in,v 1.10 2002/12/16 23:25:02 adrian Exp $

AC_INIT(lib/libgadu.h)
AC_PREREQ(2.50)
AC_CONFIG_HEADERS(config.h)

AC_PROG_CC
AC_PROG_CPP
AC_PROG_INSTALL
AC_PROG_RANLIB
AC_PROG_LN_S

AC_PATH_PROG(GMAKE, gmake, no)
if test "x$GMAKE" = "xno"; then
  AC_PATH_PROG(MAKE, make, no)
  if test "x$MAKE" = "xno"; then
    AC_MSG_ERROR([make ])
  fi
else
  MAKE="$GMAKE"
fi

AC_PATH_PROG(AR, ar, no)
if test "x$AR" = "xno"; then
  AC_MSG_ERROR([ar ])
fi

AC_PATH_PROG(STRIP, strip, :)

AC_NEED_STDINT_H
AC_C_BIGENDIAN

AC_SUBST(CFLAGS_LIBGADU)
AC_SUBST(LIBS_LIBGADU)

AC_SUBST(strip_ekg, "")
AC_SUBST(strip_ioctld, "")
AC_SUBST(strip_libgadu_so, "")

AC_SUBST(ioctld, "")
AC_SUBST(install_ioctld, "")

AC_SUBST(shared, "")
AC_SUBST(install_shared, "")

AC_SUBST(lgadu, "")

AC_SUBST(static, "static")
AC_SUBST(install_static, "install-static")

AC_SUBST(ekg, "")
AC_SUBST(install_ekg, "")
AC_SUBST(clean_ekg, "")
AC_SUBST(distclean_ekg, "")
AC_SUBST(uninstall_ekg, "")

AC_SUBST(make_ekgwap, "")
AC_SUBST(install_ekgwap, "")

AC_SUBST(OBJS, "")

echo "/* Generated automatically by configure. Do not edit. */" > lib/libgadu-config.h
cat lib/libgadu-config.h.in >> lib/libgadu-config.h

AC_TRY_RUN([
  int main() {
  #ifdef WORDS_BIGENDIAN
    return 0;
  #else
    return 1;
  #endif
  }
], [
  sed 's/#undef __GG_LIBGADU_BIGENDIAN/#define __GG_LIBGADU_BIGENDIAN/' < lib/libgadu-config.h > lib/libgadu-config.h-
  mv -f lib/libgadu-config.h- lib/libgadu-config.h
], [
  sed 's/#undef __GG_LIBGADU_BIGENDIAN.*/\/* & *\//' < lib/libgadu-config.h > lib/libgadu-config.h-
  mv -f lib/libgadu-config.h- lib/libgadu-config.h
])

# najpierw sprawdzamy te opcje, które s± wspólne dla libgadu i ekg.

AC_ARG_ENABLE(debug, 
  [  --disable-debug         Compile without debugging symbols and messages])

if test "x$enable_debug" = "xno"; then 
  CFLAGS=`echo "$CFLAGS" | sed 's/-g//'`
  CFLAGS="$CFLAGS -DGG_DEBUG_DISABLE"
  strip_ekg="strip-ekg"
  strip_ioctld="strip-ioctld"
  strip_libgadu_so="strip-libgadu-so"
else
  CFLAGS="$CFLAGS -g" 
fi

dnl sparc libs...
AC_CHECK_LIB(nsl, t_accept, LIBS="$LIBS -lnsl")
AC_CHECK_LIB(socket, socket, LIBS="$LIBS -lsocket")

AC_CHECK_FUNCS([gethostbyname_r])

# jak± wersjê libgadu kompilujemy?

AC_ARG_ENABLE(shared,
  [  --enable-shared         Compile shared version of libgadu])

lib_shared_enabled=no
  
if test "x$enable_shared" = "xyes"; then
  shared="shared"
  install_shared="install-shared"
  lib_shared_enabled=yes
fi

AC_ARG_ENABLE(static,
  [  --disable-static        Don't compile static version of libgadu

Optional ekg Features:])

lib_static_enabled=yes

if test "x$enable_static" = "xno"; then
  static=""
  install_static=""
  lib_static_enabled=no
fi

if test "x$enable_static" = "xno" -a "x$enable_shared" != "xyes"; then
  AC_MSG_ERROR([You must choose either static or shared version of libgadu.])
fi

AC_ARG_ENABLE(dynamic,
  [  --enable-dynamic        Link ekg dynamically with libgadu])

AC_MSG_CHECKING([for C99-compatible vsnprintf()])
AC_TRY_RUN(
 [#include <stdio.h>
 
  int main()
  {
    char tmp;
    return (snprintf(&tmp, sizeof(tmp), "test") != 4);
  }], [AC_DEFINE(HAVE_C99_VSNPRINTF, 1, [define if you have C99-aware vsnprintf])
  AC_MSG_RESULT([yes])], [AC_MSG_RESULT([no])])

AC_ARG_WITH(pthread,
  [  --with-pthread          Use pthread in resolver])

if test "x$with_pthread" = "xyes"; then
  AC_CHECK_HEADER(pthread.h, [
    AC_CHECK_LIB(pthread, pthread_create, [
      AC_DEFINE(HAVE_PTHREAD, 1, [Define if you want to use pthread in resolver])
      LIBS="$LIBS -lpthread"

      sed 's/#undef __GG_LIBGADU_HAVE_PTHREAD/#define __GG_LIBGADU_HAVE_PTHREAD/' < lib/libgadu-config.h > lib/libgadu-config.h-
      mv -f lib/libgadu-config.h- lib/libgadu-config.h
      libgadu_have_pthread=yes
    ])
  ])
fi

if test "x$libgadu_have_pthread" != "xyes"; then
  sed 's/#undef __GG_LIBGADU_HAVE_PTHREAD/\/* & *\//' < lib/libgadu-config.h > lib/libgadu-config.h-
  mv -f lib/libgadu-config.h- lib/libgadu-config.h
fi

# zachowujemy opcje dla libgadu

CFLAGS_LIBGADU="$CFLAGS_LIBGADU $CFLAGS"
LIBS_LIBGADU="$LIBS_LIBGADU $LIBS"


AC_CONFIG_FILES(Makefile lib/Makefile examples/Makefile lib/libgadu.pc)

AC_OUTPUT

echo
echo "configured options:"

if test "x$lib_static_enabled" = "xyes"; then
  if test "x$lib_static_default" = "xyes"; then
    echo " - static libgadu: enabled (default)"
  else
    echo " - static libgadu: enabled"
  fi
else
  echo " - static libgadu: disabled"
fi

if test "x$lib_shared_enabled" = "xyes"; then
  if test "x$lib_shared_default" = "xyes"; then
    echo " - shared libgadu: enabled (default)"
  else
    echo " - shared libgadu: enabled"
  fi
else
  echo " - shared libgadu: disabled"
fi

